#!/bin/bash
#
# run a specific component of fedbiomed
#

# detect how the file is run
(return 0 2>/dev/null) && sourced=1 || sourced=0
if [ "${sourced}" == "1" ]
then
    echo "This file MUST NOT be sourced"
    return
fi

#Activate conda with any of the next commands
#source ~/miniconda3/bin/activate
#source ~/.bashrc

eval "$(conda shell.bash hook)"

#
# find the directory containing all sources
#
#
basedir=$(cd $(dirname $0)/../.. || exit ; pwd)
cd $basedir || exit

#
case $1 in

    network)
        source ./fedbiomed-network/scripts/fedbiomed_environment reset
        source ./fedbiomed-network/scripts/fedbiomed_environment network
        cd ./fedbiomed-network/envs/development/network
        ./deploy.sh --local
        ;;

    node)

        case $2 in
            add|--add)
                source ./fedbiomed-network/scripts/fedbiomed_environment reset
                source ./fedbiomed-network/scripts/fedbiomed_environment node
                python -m fedbiomed_cli.utils.cli --add
                ;;

            start|--start)
                export MQTT_BROKER=localhost
                export MQTT_BROKER_PORT=1883
                export UPLOADS_URL='http://localhost:8844/upload'
                if [ -z "$3"]
                then
                    unset CONFIG_FILE
                else
                    export CONFILE_FILE=$3
                fi
                source ./fedbiomed-network/scripts/fedbiomed_environment reset
                source ./fedbiomed-network/scripts/fedbiomed_environment node
                python -m fedbiomed_cli.utils.cli --start
                ;;
            *)
                echo "please run node with add or start option"
                exit -1
                ;;
        esac
        ;;

    researcher)
        source ./fedbiomed-network/scripts/fedbiomed_environment reset
        source ./fedbiomed-network/scripts/fedbiomed_environment researcher
        cd fedbiomed-researcher/notebooks
        jupyter notebook
        ;;

    help|-h|--help)
        cat <<EOF
usage: fedbiomed_run network
       fedbiomed_run researcher
       fedbiomed_run node       add   (config_name.ini)
       fedbiomed_run node       start (config_name.ini)

Runs the fedbiomed components after properly initializing the environments.
The component name is mandatory.

network   : run the necessary docker containers (in development mode)

researcher: launch a researcher notebook

node      : launch a new node.
            add/start is mandatory and specify if new data must be added
            or is the node is ran on known data

            if a config_name.ini file is given, it is used instead of the
            default one (config.ini)
EOF
        ;;

    *)
        echo "Please specify the component you want to run between: network, node, researcher"
        exit -1
        ;;
esac
