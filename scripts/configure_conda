#!/bin/bash
#
# create all necessary environments
#

# list of env to find/intialise
fed_envs=(network node researcher)

# detect how the file is run
([[ -n $ZSH_EVAL_CONTEXT && $ZSH_EVAL_CONTEXT =~ :file$ ]] ||
 [[ -n $KSH_VERSION && $(cd "$(dirname -- "$0")" &&
    printf '%s' "${PWD%/}/")$(basename -- "$0") != "${.sh.file}" ]] ||
 [[ -n $BASH_VERSION ]] && (return 0 2>/dev/null)) && sourced=1 || sourced=0

[[ "${sourced}" == "1" ]] && echo "This file MUST NOT be sourced" && return

# activate conda
c=$(which conda)
if [ -z "$c" ]
then
    echo "Please install conda first !!!"
    exit -1
fi
eval "$(conda shell.bash hook)"

#update conda environment after installing modules with pip may result into inconsistencies
function activate_environment() {
    echo "* Verifying/installing conda environment: $1"
    conda env update --file $basedir/envs/development/conda/$1.yaml 2>/dev/null;
}

#
# find the directory containing all sources
#
basedir=$(cd $(dirname $0)/.. || exit ; pwd)
cd $basedir || exit

# configure/update all conda environements
for i in ${fed_envs[@]}
do
    activate_environment fedbiomed-$i
    conda deactivate
done
